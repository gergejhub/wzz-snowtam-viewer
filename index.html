<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ECAC Airports — METAR/TAF + SNOWTAM + Eurocontrol Tactical — v19.0 (rebuild)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; width:100%; margin:0; padding:0; background:#0e0f12; color:#e9eef3; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  .app { display:grid; grid-template-columns: 1fr 420px; grid-template-rows:56px calc(100vh - 56px); grid-template-areas: "topbar topbar" "map panel"; height:100vh; width:100%; }
  .topbar { grid-area: topbar; display:flex; gap:10px; align-items:center; padding:8px 14px; background:#14161a; border-bottom:1px solid #23262d; }
  .topbar h1 { font-size:16px; margin:0; font-weight:600; }
  .spacer{flex:1}
  .btn { background:#1e222a; color:#e9eef3; border:1px solid #2a2f39; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover { background:#242a34; }
  #map { grid-area: map; height: 100%; width: 100%; }
  .legend { position:absolute; right:440px; bottom:12px; background:#14161a; border:1px solid #2a2f39; padding:10px 12px; border-radius:8px; font-size:12px; z-index:500; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .dot.grey{ background:#9aa0a6; } .dot.yellow{ background:#f5c744; } .dot.orange{ background:#ff8c42; } .dot.red{ background:#ff4d4d; }
  .dot.blue{ background:#60a5fa; } .dot.amber{ background:#f59e0b; } .dot.pink{ background:#f472b6; } .dot.teal{ background:#2dd4bf; } .dot.lime{ background:#a3e635; }
  .dot.purple{ background:#a78bfa; } .dot.indigo{ background:#818cf8; } .dot.cyan{ background:#22d3ee; }
  .panel { grid-area: panel; border-left:1px solid #23262d; background:#121417; display:flex; flex-direction:column; min-width:360px; overflow:auto; }
  .panel h2 { font-size:14px; margin:10px 12px 6px; }
  .panel .filters { display:flex; flex-wrap: wrap; gap:6px 8px; padding:0 10px 8px; }
  .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #2a2f39; border-radius:999px; padding:4px 8px; font-size:12px; background:#171a1f; user-select:none; }
  .chip input{ margin:0 }
  .list { overflow:auto; padding:0 8px 12px; }
  .card { border:1px solid #2a2f39; border-radius:8px; padding:8px; margin:8px; background:#171a1f; }
  .card .hdr { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:4px; flex-wrap: wrap; }
  .card .icao { font-weight:700; letter-spacing:.3px; }
  .badge { font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #2a2f39; background:#0f1115; }
  .badge-blue{ border-color:#93c5fd; background:#dbeafe; color:#1e3a8a }
  .badge-amber{ border-color:#fcd34d; background:#fef3c7; color:#78350f }
  .badge-pink{ border-color:#fbcfe8; background:#fce7f3; color:#831843 }
  .badge-teal{ border-color:#99f6e4; background:#ccfbf1; color:#115e59 }
  .badge-lime{ border-color:#d9f99d; background:#ecfccb; color:#3f6212 }
  .badge-purple{ border-color:#c4b5fd; background:#ede9fe; color:#5b21b6 }
  .badge-indigo{ border-color:#c7d2fe; background:#e0e7ff; color:#3730a3 }
  .badge-cyan{ border-color:#a5f3fc; background:#cffafe; color:#155e75 }
  .sub { font-size:10px; opacity:.9; margin-left:6px; padding:2px 6px; border-radius:999px; border:1px dashed #93c5fd; background:#e6f0ff; color:#1e3a8a }
  .toast { position: fixed; right: 14px; top: 14px; display:flex; flex-direction:column; gap:8px; z-index: 3000; }
  .diag { position: fixed; left: 12px; bottom: 12px; background:#222; border:1px solid #555; padding:8px 10px; border-radius:6px; font-size:12px; z-index:1000; max-width:60vw; }
  .runway-rect { stroke: none !important; }
  .rwy-green{ fill:#77dd77; opacity:.75 } .rwy-yellow{ fill:#ffe680; opacity:.80 } .rwy-orange{ fill:#ffb266; opacity:.82 } .rwy-red{ fill:#ff8080; opacity:.85 }
  .modal { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.55); z-index: 4000; }
  .modal.show { display:flex; }
  .modal .box { width: min(980px, 95vw); background:#0f1115; border:1px solid #2a2f39; border-radius:10px; box-shadow: 0 20px 40px rgba(0,0,0,.45); }
  .modal .hd { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #23262d; }
  .modal .hd h3 { margin:0; font-size:14px; }
  .modal .bd { padding:10px 12px; }
  .modal textarea { width:100%; height: 340px; background:#0b0d10; color:#e9eef3; border:1px solid #2a2f39; border-radius:8px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .modal .ft { display:flex; gap:8px; justify-content:flex-end; padding:10px 12px; border-top:1px solid #23262d; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h1>ECAC Airports — v19.0 (rebuild)</h1>
    <span id="lbl-count" style="opacity:.8;font-size:12px;">Airports: —</span>
    <div class="spacer"></div>
    <label class="chip" style="cursor:pointer;"><input id="cb-runways" type="checkbox" /> Show runways</label>
    <button id="btn-euro" class="btn">Fetch Tactical Update</button>
    <button id="btn-autoTU" class="btn" data-on="1">Auto TU: ON</button>
    <span id="tu-next" style="opacity:.7;font-size:12px;">—</span>
    <button id="btn-notif" class="btn">Enable notifications</button>
    <button id="btn-paste" class="btn">Paste TU</button>
    <button id="btn-reload" class="btn">Reload airports</button>
    <button id="btn-refresh" class="btn">Refresh METAR/TAF</button>
    <button id="btn-auto" class="btn" data-on="1">Auto 15m: ON</button>
  </div>
  <div id="map"></div>
  <div class="panel">
    <h2>Tactical Update (Eurocontrol)</h2>
    <div id="tu-time" style="opacity:.8;font-size:12px;margin:0 12px 6px;">—</div>
    <div class="filters">
      <label class="chip"><input type="checkbox" data-cat="WEATHER" checked><span class="dot blue"></span>Weather <span class="sub">TS/CB, Low Vis, Strong Wind, Snow/Ice, Heavy Rain</span></label>
      <label class="chip"><input type="checkbox" data-cat="RUNWAY_STATUS" checked><span class="dot purple"></span>Runway/Closure</label>
      <label class="chip"><input type="checkbox" data-cat="ATC_CAPACITY" checked><span class="dot amber"></span>ATC Capacity</label>
      <label class="chip"><input type="checkbox" data-cat="ATC_STAFFING" checked><span class="dot pink"></span>ATC Staffing</label>
      <label class="chip"><input type="checkbox" data-cat="AIRSPACE" checked><span class="dot cyan"></span>Airspace/Restrictions</label>
      <label class="chip"><input type="checkbox" data-cat="EQUIPMENT" checked><span class="dot indigo"></span>Equipment/Tech</label>
      <label class="chip"><input type="checkbox" data-cat="INDUSTRIAL" checked><span class="dot teal"></span>Industrial Action</label>
      <label class="chip"><input type="checkbox" data-cat="OTHER" checked><span class="dot lime"></span>Other</label>
    </div>
    <div class="list" id="tu-list"></div>
  </div>
  <div class="legend">
    <div><span class="dot grey"></span>No SNOWTAM</div>
    <div><span class="dot yellow"></span>SNOWTAM: YELLOW</div>
    <div><span class="dot orange"></span>SNOWTAM: ORANGE</div>
    <div><span class="dot red"></span>SNOWTAM: RED</div>
    <div style="margin-top:6px;">Marker stroke colors (Tactical Update):</div>
    <div><span class="dot blue"></span>Weather</div>
    <div><span class="dot purple"></span>Runway/Closure</div>
    <div><span class="dot amber"></span>ATC Capacity</div>
    <div><span class="dot pink"></span>ATC Staffing</div>
    <div><span class="dot cyan"></span>Airspace/Restrictions</div>
    <div><span class="dot indigo"></span>Equipment/Tech</div>
    <div><span class="dot teal"></span>Industrial Action</div>
    <div><span class="dot lime"></span>Other</div>
  </div>
</div>
<div id="toast" class="toast"></div>
<div id="diag" class="diag">Diagnostics: booting…</div>

<!-- Paste TU Modal -->
<div id="pasteModal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" aria-labelledby="pasteTitle">
    <div class="hd">
      <h3 id="pasteTitle">Paste Tactical Update</h3>
      <button id="pasteClose" class="btn">✕</button>
    </div>
    <div class="bd">
      <p style="margin:0 0 6px; opacity:.85;">If the automatic fetch fails due to CORS, paste the text here.</p>
      <textarea id="tuInput" placeholder="Paste here..."></textarea>
    </div>
    <div class="ft">
      <button id="pasteParse" class="btn">Parse & Apply</button>
      <button id="pasteCancel" class="btn">Cancel</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const toastWrap=document.getElementById('toast'); function toast(msg){ const d=document.createElement('div'); d.className='t'; d.textContent=msg; toastWrap.appendChild(d); setTimeout(()=>d.remove(), 8000); }
const diag=document.getElementById('diag'); function say(msg){ diag.textContent='Diagnostics: '+msg; console.log('[ECAC]', msg); }
const lblCount=document.getElementById('lbl-count'); const tuNext=document.getElementById('tu-next');

const map = L.map('map', { worldCopyJump:true }).setView([49,11], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:17, minZoom:3, attribution:'&copy; OpenStreetMap'}).addTo(map);
const airportLayer=L.layerGroup().addTo(map); const runwayLayer=L.layerGroup().addTo(map);

/* fetch helpers */
function withTimeout(promise, ms, label){ let t; const timeout = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error('Timeout '+(label||'')+' '+ms+'ms')), ms)); return Promise.race([promise.then(v=>{clearTimeout(t); return v;}), timeout]); }
async function get(url){ const r=await withTimeout(fetch(url,{cache:'no-store'}),8000,url); if(!r.ok) throw new Error('HTTP '+r.status); return withTimeout(r.text(),8000,'read '+url); }
async function fetchHtmlSmart(url){
  const ts = Date.now();
  const candidates = [
    url + (url.includes('?')?'&':'?') + '_ts='+ts,
    'https://corsproxy.io/?' + encodeURIComponent(url + (url.includes('?')?'&':'?') + '_ts='+ts),
    'https://thingproxy.freeboard.io/fetch/'+url,
    'https://r.jina.ai/http://'+url.replace(/^https?:\/\//,'')
  ];
  let lastErr=null;
  for(const u of candidates){
    try{ const txt = await get(u); if(txt && txt.length>200){ say('TU fetched via '+u); return {via:u, html:txt}; } }catch(e){ lastErr=e; say('TU source failed '+u+' — '+e.message); }
  }
  throw lastErr||new Error('No TU fetchers succeeded');
}

/* sources */
const SRC={ airports:[ 'https://ourairports.com/data/airports.csv', 'https://raw.githubusercontent.com/davidmegginson/ourairports-data/master/airports.csv' ],
            runways:[ 'https://ourairports.com/data/runways.csv', 'https://raw.githubusercontent.com/davidmegginson/ourairports-data/master/runways.csv' ],
            euro_detached:'https://www.public.nm.eurocontrol.int/PUBPORTAL/gateway/spec/PORTAL.27.2.0.2.38/detachedViews/headline_news.html?viewId=DISPLAY_ITEM_DV&parameter_set_id=0',
            metar_one:(id)=>`https://aviationweather.gov/api/data/metar?ids=${id}&format=raw`,
            taf_one:(id)=>`https://aviationweather.gov/api/data/taf?ids=${id}&format=raw`,
            metar:(ids)=>`https://aviationweather.gov/api/data/metar?ids=${ids}&format=raw`,
            taf:(ids)=>`https://aviationweather.gov/api/data/taf?ids=${ids}&format=raw`,
            notam_raw1:(icao)=>`https://notams.aim.faa.gov/notamSearch/search?reportType=Raw&formatType=International&designators=${icao}`,
            notam_raw2:(icao)=>`https://www.notams.faa.gov/dinsQueryWeb/queryRetrievalMapAction.do?retrieveLocId=${icao}&actionType=notamRetrievalByICAOs&reportType=RawIntl` };
const ECAC=new Set(["AL","AM","AT","AZ","BA","BE","BG","CH","CY","CZ","DE","DK","EE","ES","FI","FR","GE","GR","HR","HU","IE","IS","IT","LI","LT","LU","LV","MC","MD","ME","MK","MT","NL","NO","PL","PT","RO","RS","SE","SI","SK","SM","TR","UA","UK"]);
const state={ airportsByIcao:new Map(), runwaysByIcao:new Map(), selectedICAO:null, autoTUTimer:null, autoTUNext:0, showRunways:false, tacticalByIcao:new Map(), _lastTUItems:null };

/* csv + markers */
function parseCSV(line){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const c=line[i]; if(c==='"'){ q=!q; continue; } if(c===','&&!q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; }
function addAirport(icao,name,lat,lon,country){ const marker = L.circleMarker([lat,lon], {radius:5, color:'#596275', weight:3, fillColor:'#9aa0a6', fillOpacity:1}); marker.addTo(airportLayer).on('click', ()=> onAirportClick(icao)); state.airportsByIcao.set(icao, {icao,name,lat,lon,country, marker}); }
async function loadAirports(){ airportLayer.clearLayers(); state.airportsByIcao.clear(); lblCount.textContent='Airports: …'; for(const url of SRC.airports){ try{ const txt=await get(url); let added=0; for(const line of txt.split('\n').slice(1)){ if(!line.trim()) continue; const cols=parseCSV(line); const ident=cols[1]; const type=cols[2]; const name=cols[3]; const lat=parseFloat(cols[4]); const lon=parseFloat(cols[5]); const ctry=(cols[8]==='GB')?'UK':cols[8]; if(!ECAC.has(ctry)) continue; if(!['large_airport','medium_airport'].includes(type)) continue; if(!ident || ident.length!==4) continue; if(!isFinite(lat)||!isFinite(lon)) continue; addAirport(ident,name,lat,lon,ctry); added++; } lblCount.textContent='Airports: '+added; say('Airports loaded'); return; }catch(e){ say('Airport load failed — '+e.message);} } }
async function loadRunways(){ try{ const csv = await get(SRC.runways[0]); const byIcao=new Map(); for(const line of csv.split('\n').slice(1)){ if(!line.trim()) continue; const c=parseCSV(line); const icao=c[2]; if(!icao||icao.length!==4) continue; const le_lat=parseFloat(c[10]), le_lon=parseFloat(c[11]); const he_lat=parseFloat(c[15]), he_lon=parseFloat(c[16]); if(!isFinite(le_lat)||!isFinite(le_lon)||!isFinite(he_lat)||!isFinite(he_lon)) continue; const width_ft=parseFloat(c[4]); const width_m=isFinite(width_ft)?Math.round(width_ft*0.3048):45; const entry={airport:icao,width_m,ends:[{lat:le_lat,lon:le_lon},{lat:he_lat,lon:he_lon}]}; if(!byIcao.has(icao)) byIcao.set(icao,[]); byIcao.get(icao).push(entry); } state.runwaysByIcao=byIcao; }catch(e){ say('Runways CSV could not be loaded.'); }}

/* runways */
function drawRunwaysFor(icao){ runwayLayer.clearLayers(); if(!state.showRunways) return; if(map.getZoom()<10) return; const list=state.runwaysByIcao.get(icao); if(!list||!list.length) return; function interp(a,b,t){return L.latLng(a.lat+(b.lat-a.lat)*t,a.lng+(b.lng-a.lng)*t);} for(const r of list){ const p1=L.latLng(r.ends[0].lat,r.ends[0].lon), p2=L.latLng(r.ends[1].lat,r.ends[1].lon); const a0=p1,a1=interp(p1,p2,1/3),a2=interp(p1,p2,2/3),a3=p2; const width=(r.width_m||45)/2, lat=(p1.lat+p2.lat)/2, m2degLat=1/111320, m2degLon=1/(111320*Math.cos(lat*Math.PI/180)); function quad(a,b){ const dx=(b.lng-a.lng), dy=(b.lat-a.lat), len=Math.hypot(dx,dy)||1e-9; const ux=-dy/len, uy=dx/len; const offLon=ux*width*m2degLon, offLat=uy*width*m2degLat; return [[a.lat-offLat,a.lng-offLon],[a.lat+offLat,a.lng+offLon],[b.lat+offLat,b.lng+offLon],[b.lat-offLat,b.lng-offLon]]; } [[a0,a1],[a1,a2],[a2,a3]].forEach((seg,i)=> L.polygon(quad(seg[0],seg[1]), { className:'runway-rect rwy-green', stroke:false }).addTo(runwayLayer)); } }
map.on('zoomend', ()=>{ if(state.selectedICAO) drawRunwaysFor(state.selectedICAO); });

/* TU parsing */
const CAT = { WEATHER:{label:'Weather', badge:'badge-blue'}, RUNWAY_STATUS:{label:'Runway/Closure',badge:'badge-purple'}, ATC_CAPACITY:{label:'ATC Capacity',badge:'badge-amber'}, ATC_STAFFING:{label:'ATC Staffing',badge:'badge-pink'}, AIRSPACE:{label:'Airspace/Restrictions',badge:'badge-cyan'}, EQUIPMENT:{label:'Equipment/Tech',badge:'badge-indigo'}, INDUSTRIAL:{label:'Industrial Action',badge:'badge-teal'}, OTHER:{label:'Other',badge:'badge-lime'} };
function cleanHtmlToText(html){ return html.replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/<br\s*\/?>(?=\s*\n)/gi,'\n').replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<[^>]+>/g,'\n'); }
function isolateTacticalBlock(textish){ const idx = textish.search(/Tactical\s+Update/i); if(idx<0) return textish; const slice = textish.slice(idx); const stop = slice.search(/^(?:\s*Current Network|\s*Ongoing News|\s*Latest News)/im); return stop>0 ? slice.slice(0,stop) : slice; }
function detectWeatherSub(s){ return (/CB\b|\bTS\b|TSRA|VCTS|LTG|thunder/i.test(s)?'Thunderstorms/CB': /low\s+(?:vis|visibility)|\bLVP\b|\bFG\b|\bBR\b|RVR/i.test(s)?'Low Visibility': /gust|LLWS|wind shear|Strong wind/i.test(s)?'Strong Wind/LLWS': /snow|ice|freez|FZRA|FZDZ|FZFG|slush|RWYCC|de-ice/i.test(s)?'Snow/Ice': /heavy rain|\+RA|torrential|SHRA/i.test(s)?'Heavy Rain':null); }
function scoreFor(text){ const S=text; const has=(rx)=>rx.test(S); const cap=has(/\bATC\b\s*capacity/i); const stf=has(/staff|controller(?:s)? shortage|reduced manning/i); const rwy=has(/\brwy\b|runway|taxiway|WIP|closure|closed|braking|contaminated|snowbank/i); const wx=has(/\bweather\b|\bwx\b|fog|hail|storm|CB\b|\bTS\b/i); const air=has(/airspace|restriction|TSA|TRA|danger area|military/i); const eqp=has(/ILS|VOR|NDB|radar|comms?|power outage|system (?:down|failure)|technical|outage/i); const ind=has(/industrial|strike|union/i); if(cap) return {cat:'ATC_CAPACITY', sub:detectWeatherSub(S)}; if(stf) return {cat:'ATC_STAFFING'}; if(rwy) return {cat:'RUNWAY_STATUS'}; if(wx) return {cat:'WEATHER', sub:detectWeatherSub(S)}; if(eqp) return {cat:'EQUIPMENT'}; if(air) return {cat:'AIRSPACE'}; if(ind) return {cat:'INDUSTRIAL'}; return {cat:'OTHER'}; }
function extractTactical(html){ const textish=cleanHtmlToText(html); const block=isolateTacticalBlock(textish); const lines=block.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); let currentICAOs=[]; const per=new Map(); for(const line of lines){ const icaos=(line.toUpperCase().match(/\b[A-Z]{4}\b/g)||[]); if(icaos.length){ currentICAOs=Array.from(new Set(icaos)); currentICAOs.forEach(c=>{ if(!per.has(c)) per.set(c,{icao:c,texts:new Set(),best:{cat:'OTHER',sub:null}}); per.get(c).texts.add(line); }); continue; } if(!currentICAOs.length) continue; const sc=scoreFor(line); for(const c of currentICAOs){ const rec=per.get(c); rec.texts.add(line); if(rec.best.cat==='OTHER' || sc.cat==='ATC_CAPACITY' || (sc.cat!=='OTHER' && rec.best.cat==='WEATHER' && sc.cat!=='WEATHER')) rec.best=sc; } } const items=Array.from(per.values()).map(v=>({icao:v.icao,text:Array.from(v.texts).join('\n'),cat:v.best.cat,catLabel:CAT[v.best.cat].label,badgeCls:CAT[v.best.cat].badge,sub:v.best.sub||null})); const time=(textish.match(/\b\d{2}:\d{2}\b/)||[])[0]||''; return {items,time,raw:block}; }

function applyFilters(items){ const boxen = Array.from(document.querySelectorAll('.filters input[type=checkbox]')); const enabled = new Set(boxen.filter(b=>b.checked).map(b=>b.dataset.cat)); return items.filter(it=> enabled.has(it.cat)); }
function updateTacticalUI(items, time){ const list=document.getElementById('tu-list'); const tdiv=document.getElementById('tu-time'); if(!items||!items.length){ toast('No TU items parsed.'); return; } list.innerHTML=''; tdiv.textContent=time?('Time: '+time):'—'; const filtered=applyFilters(items); const seen=new Set(); filtered.forEach(item=>{ const a=state.airportsByIcao.get(item.icao); if(!a) return; state.tacticalByIcao.set(item.icao,item); a.marker.setStyle({color:'#f59e0b',weight:4}); if(!seen.has(item.icao)){ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="hdr"><span class="icao">${item.icao}</span><span class="badge ${item.badgeCls}">${item.catLabel}</span>${item.sub?`<span class="sub">${item.sub}</span>`:''}<button class="btn" data-icao="${item.icao}">Zoom</button></div><div style="font-size:12px;white-space:pre-wrap;opacity:.95;">${item.text}</div>`; d.querySelector('button').addEventListener('click', ()=>{ const a=state.airportsByIcao.get(item.icao); if(a){ map.setView([a.lat,a.lon],10); rebuildPopup(item.icao); } }); list.appendChild(d); seen.add(item.icao);} }); toast('Tactical Update: '+filtered.length+' entries.'); }

async function fetchEuroTacticalAuto(){ try{ const {via,html}=await fetchHtmlSmart(SRC.euro_detached); const parsed=extractTactical(html); if(parsed.items.length){ state._lastTUItems=parsed.items; updateTacticalUI(parsed.items, parsed.time); say('TU parsed from '+via+' — items: '+parsed.items.length); return true; } }catch(e){ say('Auto TU failed: '+e.message); } return false; }

/* popup */
function buildPopupHTML(icao){ const a=state.airportsByIcao.get(icao)||{}; const tu=state.tacticalByIcao.get(icao); return `<div class="popup"><h3>${icao} — ${a.name||''} ${tu?(`<span class="badge ${tu.badgeCls}">${tu.catLabel}</span>` + (tu.sub?`<span class="sub">${tu.sub}</span>`:'')) : ''}</h3></div>`; }
function rebuildPopup(icao){ const a=state.airportsByIcao.get(icao); if(!a) return; L.popup({maxWidth:720,autoPan:true}).setLatLng([a.lat,a.lon]).setContent(buildPopupHTML(icao)).openOn(map); }
async function onAirportClick(icao){ state.selectedICAO=icao; const a=state.airportsByIcao.get(icao); if(!a) return; if(map.getZoom()<11) map.setView([a.lat,a.lon],11); else map.panTo([a.lat,a.lon]); rebuildPopup(icao); drawRunwaysFor(icao); }

/* Paste TU modal */
const modal=document.getElementById('pasteModal'); const txtArea=document.getElementById('tuInput');
function openPaste(){ modal.classList.add('show'); txtArea.value=''; txtArea.focus(); }
function closePaste(){ modal.classList.remove('show'); }
document.getElementById('btn-paste').addEventListener('click', openPaste);
document.getElementById('pasteClose').addEventListener('click', closePaste);
document.getElementById('pasteCancel').addEventListener('click', closePaste);
document.getElementById('pasteParse').addEventListener('click', ()=>{ const raw=txtArea.value||''; const parsed=extractTactical(raw); if(parsed.items.length){ state._lastTUItems=parsed.items; updateTacticalUI(parsed.items, parsed.time); toast('TU set from PASTE.'); closePaste(); } else toast('No ICAOs found in pasted text.'); });

/* controls */
document.getElementById('btn-autoTU').addEventListener('click', (e)=>{ const on=e.currentTarget.dataset.on==='1'; if(on){ e.currentTarget.dataset.on='0'; e.currentTarget.textContent='Auto TU: OFF'; clearInterval(state.autoTUTimer);} else { e.currentTarget.dataset.on='1'; e.currentTarget.textContent='Auto TU: ON'; scheduleTU(); } });
document.getElementById('btn-euro').addEventListener('click', ()=>fetchEuroTacticalAuto().then(ok=>toast(ok?'Pulled TU from NM.':'Failed to pull TU.')));
document.getElementById('cb-runways').addEventListener('change', (e)=>{ state.showRunways=e.currentTarget.checked; runwayLayer.clearLayers(); if(state.showRunways && state.selectedICAO) drawRunwaysFor(state.selectedICAO); });

function scheduleTU(){ clearInterval(state.autoTUTimer); const intervalMs=10*60*1000; const tick=()=>{ fetchEuroTacticalAuto(); state.autoTUNext=Date.now()+intervalMs; }; tick(); state.autoTUTimer=setInterval(tick, intervalMs); }
setInterval(()=>{ if(state.autoTUNext>0){ const s=Math.max(0, Math.floor((state.autoTUNext-Date.now())/1000)); tuNext.textContent='Next TU in '+String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); } }, 1000);

/* boot */
(async function boot(){ await loadAirports(); await loadRunways(); scheduleTU(); say('Ready. v19.0 rebuild.'); })();
</script>
</body>
</html>
