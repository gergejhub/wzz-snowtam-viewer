<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ECAC Airports — METAR/TAF + SNOWTAM — v13</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; background:#0e0f12; color:#e9eef3; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .app { display:grid; grid-template-rows:56px 1fr; height:100vh; }
  .topbar { display:flex; gap:12px; align-items:center; padding:8px 14px; background:#14161a; border-bottom:1px solid #23262d; }
  .topbar h1 { font-size:16px; margin:0; font-weight:600; }
  .spacer{flex:1}
  .btn { background:#1e222a; color:#e9eef3; border:1px solid #2a2f39; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover { background:#242a34; }
  #map { height: calc(100vh - 56px); }
  .legend { position:absolute; right:12px; bottom:12px; background:#14161a; border:1px solid #2a2f39; padding:10px 12px; border-radius:8px; font-size:12px; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .dot.grey{ background:#9aa0a6; } .dot.yellow{ background:#f5c744; } .dot.orange{ background:#ff8c42; } .dot.red{ background:#ff4d4d; }
  .toast { position: fixed; right: 14px; top: 14px; display:flex; flex-direction:column; gap:8px; z-index: 3000; }
  .toast .t { background:#14161a; border:1px solid #2a2f39; color:#e9eef3; padding:8px 10px; border-radius:8px; font-size:13px; box-shadow: 0 6px 18px rgba(0,0,0,.3); }
  .diag { position: fixed; left: 12px; bottom: 12px; background:#222; border:1px solid #555; padding:8px 10px; border-radius:6px; font-size:12px; z-index:1000; max-width: 60vw; }
  .runway-rect { stroke:none; } /* stroke removed to avoid stray line */
  .rwy-green{fill:#77dd77;opacity:.75}.rwy-yellow{fill:#ffe680;opacity:.8}.rwy-orange{fill:#ffb266;opacity:.8}.rwy-red{fill:#ff8080;opacity:.85}
  .rwy-outline{color:#f1f3f5;font-size:12px;text-shadow:0 2px 3px #000}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h1>ECAC Airports — v13</h1>
    <span id="lbl-count" style="opacity:.8;font-size:12px;">Airports: —</span>
    <div class="spacer"></div>
    <label style="display:flex;align-items:center;gap:6px;opacity:.9;">
      <input type="checkbox" id="chk-runways" checked/> Show Runways
    </label>
    <button id="btn-reload" class="btn">Reload airports</button>
    <button id="btn-refresh" class="btn">Refresh now</button>
    <button id="btn-auto" class="btn" data-on="1">Auto 15m: ON</button>
  </div>
  <div id="map"></div>
  <div class="legend">
    <div><span class="dot grey"></span>Normal (no active SNOWTAM)</div>
    <div><span class="dot yellow"></span>SNOWTAM: YELLOW</div>
    <div><span class="dot orange"></span>SNOWTAM: ORANGE</div>
    <div><span class="dot red"></span>SNOWTAM: RED</div>
  </div>
</div>
<div id="toast" class="toast"></div>
<div id="diag" class="diag">Diagnostics: booting…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== utilities ===== */
const toastWrap=document.getElementById('toast');
function toast(msg){ const d=document.createElement('div'); d.className='t'; d.textContent=msg; toastWrap.appendChild(d); setTimeout(()=>d.remove(), 3000); }
const diag=document.getElementById('diag'); function say(msg){ diag.textContent='Diagnostics: '+msg; }
const lblCount=document.getElementById('lbl-count');

const map = L.map('map', { worldCopyJump:true }).setView([49,11], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:17, minZoom:3, attribution:'&copy; OpenStreetMap'}).addTo(map);
const airportLayer=L.layerGroup().addTo(map); const runwayLayer=L.layerGroup().addTo(map);

/* multiple proxy paths */
const PROXIES=[ (u)=>u, (u)=>'https://corsproxy.io/?'+encodeURIComponent(u), (u)=>'https://thingproxy.freeboard.io/fetch/'+u, (u)=>'https://r.jina.ai/http://'+u.replace(/^https?:\/\//,'') ];
async function fetchViaAll(url){ let last=null; for(const wrap of PROXIES){ try{ const r=await fetch(wrap(url),{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); const t=await r.text(); if(t && t.length>10) return t; }catch(e){ last=e; } } throw last||new Error('All proxies failed'); }

/* data sources */
const SRC={
  airports:[
    'https://ourairports.com/data/airports.csv',
    'https://raw.githubusercontent.com/davidmegginson/ourairports-data/master/airports.csv'
  ],
  runways:[
    'https://ourairports.com/data/runways.csv',
    'https://raw.githubusercontent.com/davidmegginson/ourairports-data/master/runways.csv'
  ],
  metar_one:(id)=>`https://aviationweather.gov/api/data/metar?ids=${id}&format=raw`,
  taf_one:(id)=>`https://aviationweather.gov/api/data/taf?ids=${id}&format=raw`,
  metar:(ids)=>`https://aviationweather.gov/api/data/metar?ids=${ids}&format=raw`,
  taf:(ids)=>`https://aviationweather.gov/api/data/taf?ids=${ids}&format=raw`,
  notam_raw1:(icao)=>`https://notams.aim.faa.gov/notamSearch/search?reportType=Raw&formatType=International&designators=${icao}`,
  notam_raw2:(icao)=>`https://www.notams.faa.gov/dinsQueryWeb/queryRetrievalMapAction.do?retrieveLocId=${icao}&actionType=notamRetrievalByICAOs&reportType=RawIntl`
};
const ECAC=new Set(["AL","AM","AT","AZ","BA","BE","BG","CH","CY","CZ","DE","DK","EE","ES","FI","FR","GE","GR","HR","HU","IE","IS","IT","LI","LT","LU","LV","MC","MD","ME","MK","MT","NL","NO","PL","PT","RO","RS","SE","SI","SK","SM","TR","UA","UK"]);

/* embedded fallback major airports (subset) */
const EMBED_MAJOR=[
  ["EGLL","London Heathrow",51.4700,-0.4543,"UK"],
  ["EGKK","London Gatwick",51.1481,-0.1903,"UK"],
  ["EHAM","Amsterdam Schiphol",52.3086,4.7639,"NL"],
  ["EDDF","Frankfurt Main",50.0379,8.5622,"DE"],
  ["EDDM","Munich",48.3538,11.7861,"DE"],
  ["LFPG","Paris CDG",49.0097,2.5479,"FR"],
  ["LFPO","Paris Orly",48.7262,2.3652,"FR"],
  ["LEMD","Madrid Barajas",40.4936,-3.5668,"ES"],
  ["LEBL","Barcelona",41.2974,2.0833,"ES"],
  ["LIRF","Rome Fiumicino",41.8003,12.2389,"IT"],
  ["LIMC","Milan Malpensa",45.6301,8.7231,"IT"],
  ["LOWW","Vienna",48.1103,16.5697,"AT"],
  ["LHBP","Budapest",47.4369,19.2556,"HU"],
  ["LKPR","Prague",50.1008,14.26,"CZ"],
  ["EPWA","Warsaw",52.1657,20.9671,"PL"],
  ["LKTB","Brno",49.1513,16.6944,"CZ"],
  ["LRCL","Cluj-Napoca",46.7852,23.6862,"RO"],
  ["LRBS","Bucharest Baneasa",44.5032,26.1021,"RO"],
  ["LRBS","Bucharest Baneasa",44.5032,26.1021,"RO"],
  ["LROP","Bucharest OTP",44.5711,26.0850,"RO"],
  ["LBSF","Sofia",42.6950,23.4062,"BG"],
  ["LJLJ","Ljubljana",46.2237,14.4576,"SI"],
  ["LDZA","Zagreb",45.7429,16.0688,"HR"],
  ["LWSK","Skopje",41.9616,21.6214,"MK"],
  ["LQSA","Sarajevo",43.8246,18.3315,"BA"],
  ["LYBE","Belgrade",44.8184,20.3091,"RS"],
  ["LTFM","Istanbul IST",41.2622,28.7278,"TR"],
  ["LTBA","Istanbul Atatürk (closed)",40.9769,28.8146,"TR"],
  ["LTFJ","Sabiha Gokcen",40.8986,29.3092,"TR"],
  ["LGAV","Athens",37.9363,23.9475,"GR"],
  ["LCLK","Larnaca",34.8751,33.6249,"CY"],
  ["EKCH","Copenhagen",55.6181,12.6561,"DK"],
  ["ESSA","Stockholm Arlanda",59.6498,17.9238,"SE"],
  ["ENGM","Oslo Gardermoen",60.1939,11.1004,"NO"],
  ["EFHK","Helsinki",60.3172,24.9633,"FI"],
  ["ELLX","Luxembourg",49.6266,6.2115,"LU"],
  ["EIDW","Dublin",53.4213,-6.27,"IE"],
  ["LZIB","Bratislava",48.1702,17.2127,"SK"],
  ["LBSF","Sofia",42.6950,23.4062,"BG"],
  ["LQBK","Banja Luka",44.9414,17.2975,"BA"]
];

/* state */
const state={ airportsByIcao:new Map(), runwaysByIcao:new Map(), metarByIcao:new Map(), tafByIcao:new Map(), snowtamByIcao:new Map(), selectedICAO:null, autoTimer:null };

/* helpers */
function parseCSV(line){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const c=line[i]; if(c==='\"'){ q=!q; continue; } if(c===','&&!q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; }
function addAirport(icao,name,lat,lon,country){
  const marker = L.circleMarker([lat,lon], {radius:4, color:'#555', weight:1, fillColor:'#9aa0a6', fillOpacity:1});
  marker.addTo(airportLayer).on('click', ()=> onAirportClick(icao));
  state.airportsByIcao.set(icao, {icao,name,lat,lon,country, marker});
}
function styleMarker(icao,cat){
  const a=state.airportsByIcao.get(icao); if(!a) return;
  const m=a.marker;
  if(!cat){ m.setStyle({fillColor:'#9aa0a6'}); return; }
  if(cat==='RED') m.setStyle({fillColor:'#ff4d4d'});
  else if(cat==='ORANGE') m.setStyle({fillColor:'#ff8c42'});
  else if(cat==='YELLOW') m.setStyle({fillColor:'#f5c744'});
}

/* load airports with robust fallback */
async function loadAirports(){
  airportLayer.clearLayers(); state.airportsByIcao.clear();
  lblCount.textContent='Airports: …';
  // Try online CSVs
  for(const url of SRC.airports){
    try{
      const csv = await fetchViaAll(url);
      let added=0;
      for(const line of csv.split('\n').slice(1)){
        if(!line.trim()) continue;
        const cols=parseCSV(line); const ident=cols[1]; const type=cols[2]; const name=cols[3]; const lat=parseFloat(cols[4]); const lon=parseFloat(cols[5]); const ctry=(cols[8]==='GB')?'UK':cols[8];
        if(!ECAC.has(ctry)) continue;
        if(!['large_airport','medium_airport'].includes(type)) continue;
        if(!ident || ident.length!==4) continue;
        if(!isFinite(lat)||!isFinite(lon)) continue;
        addAirport(ident,name,lat,lon,ctry); added++;
      }
      lblCount.textContent='Airports: '+added;
      say('Airports loaded from '+url);
      return;
    }catch(e){ /* try next */ }
  }
  // Fallback to embedded list if online failed
  EMBED_MAJOR.forEach(([icao,name,lat,lon,c])=> addAirport(icao,name,lat,lon,c));
  lblCount.textContent='Airports: '+EMBED_MAJOR.length+' (embedded fallback)';
  say('Using embedded major-airports fallback — network/CORS issue on data feeds?');
}

/* runways (optional) — trimmed: only draw when we have data */
async function loadRunways(){
  try{
    const csv = await fetchViaAll(SRC.runways[0]).catch(()=>fetchViaAll(SRC.runways[1]));
    const byIcao=new Map();
    for(const line of csv.split('\n').slice(1)){
      if(!line.trim()) continue;
      const c=parseCSV(line); const icao=c[2]; if(!icao||icao.length!==4) continue;
      const length_ft=parseFloat(c[3]), width_ft=parseFloat(c[4]);
      const le_ident=c[8], le_lat=parseFloat(c[10]), le_lon=parseFloat(c[11]);
      const he_ident=c[13], he_lat=parseFloat(c[15]), he_lon=parseFloat(c[16]);
      if(!isFinite(le_lat)||!isFinite(le_lon)||!isFinite(he_lat)||!isFinite(he_lon)) continue;
      const length_m=isFinite(length_ft)?Math.round(length_ft*0.3048):null;
      const width_m=isFinite(width_ft)?Math.round(width_ft*0.3048):45;
      const entry={airport:icao,ident:`${le_ident}/${he_ident}`,length_m,width_m,ends:[{ident:le_ident,lat:le_lat,lon:le_lon},{ident:he_ident,lat:he_lat,lon:he_lon}]};
      if(!byIcao.has(icao)) byIcao.set(icao,[]); byIcao.get(icao).push(entry);
    }
    state.runwaysByIcao=byIcao;
  }catch(e){ say('Runways CSV could not be loaded. Overlay may be unavailable.'); }
}

/* METAR/TAF & SNOWTAM */
async function fetchMetarOne(icao){
  try{ const t=await fetchViaAll(SRC.metar_one(icao)); const line=(t||'').split('\n').filter(Boolean)[0]; if(line){ state.metarByIcao.set(icao,line); const el=document.getElementById('m_'+icao); if(el) el.textContent=line; } }catch(e){}
}
async function fetchTafOne(icao){
  try{ const t=await fetchViaAll(SRC.taf_one(icao)); const line=(t||'').split('\n').filter(Boolean)[0]; if(line){ state.tafByIcao.set(icao,line); const el=document.getElementById('t_'+icao); if(el) el.textContent=line; } }catch(e){}
}
function parseList3(s){ if(!s) return [null,null,null]; const p=s.split('/').map(x=>x.trim()).slice(0,3); while(p.length<3) p.push(null); return p; }
function classifyFromCC(a){ if(a.some(x=>x===1||x===0))return 'RED'; if(a.some(x=>x===2||x===3))return 'ORANGE'; if(a.some(x=>x===4||x===5))return 'YELLOW'; return null; }
function decodeSnowtam(raw){ const g=(tag)=>{const m=raw.match(new RegExp(`\\b${tag}\\)\\s*([^\\n\\r]+)`,'i')); return m?m[1].trim():null;}; const A=g('A'),C=g('C'),D=g('D'),E=g('E'),F=g('F'),G=g('G'),H=g('H'),B=g('B'),N=g('N'),T=g('T'); const rwycc=parseList3(D).map(x=>x==null?null:parseInt(x,10)); const cat=classifyFromCC(rwycc); const thirds=['TDZ','MID','END']; const lines=[]; if(A)lines.push('Aerodrome: '+A); if(B)lines.push('Time: '+B); if(C)lines.push('Runway(s): '+C); if(rwycc.some(v=>v!=null))lines.push('RWYCC: '+rwycc.join('/')); if(E)lines.push('Coverage %: '+E); if(F)lines.push('Depth (mm): '+F); if(G)lines.push('Condition: '+G); if(H)lines.push('Width (m): '+H); if(N)lines.push('Remarks: '+N); if(T)lines.push('Method: '+T); return {decoded:lines.join('\n'), category:cat, rwycc}; }
async function fetchSnowtamFAA(icao){
  for(const u of [SRC.notam_raw1(icao), SRC.notam_raw2(icao)]){
    try{ const t=await fetchViaAll(u); const plain=t.replace(/<[^>]+>/g,'\n'); const block=plain.split(/\n\s*\n+/).find(b=>/SNOWTAM/i.test(b)&&b.toUpperCase().includes(icao)); if(block){ const d=decodeSnowtam(block.trim()); return { raw:block.trim(), decoded:d.decoded, category:d.category, rwycc:d.rwycc }; } }catch(e){}
  } return null;
}

/* Runway drawing */
function drawRunwaysFor(icao){
  runwayLayer.clearLayers();
  if(!document.getElementById('chk-runways').checked) return;
  if(map.getZoom()<10) return;
  const list=state.runwaysByIcao.get(icao); if(!list||!list.length) return;
  const rwycc=state.snowtamByIcao.get(icao)?.rwycc||null;
  function interp(a,b,t){return L.latLng(a.lat+(b.lat-a.lat)*t,a.lng+(b.lng-a.lng)*t);}
  function classForThird(i){ const c=Array.isArray(rwycc)?rwycc[i]:null; if(c==null) return 'rwy-green'; if(c<=1) return 'rwy-red'; if(c<=3) return 'rwy-orange'; if(c<=5) return 'rwy-yellow'; return 'rwy-green'; }
  for(const r of list){
    const p1=L.latLng(r.ends[0].lat,r.ends[0].lon), p2=L.latLng(r.ends[1].lat,r.ends[1].lon);
    const a0=p1,a1=interp(p1,p2,1/3),a2=interp(p1,p2,2/3),a3=p2;
    const width=(r.width_m||45)/2, lat=(p1.lat+p2.lat)/2, m2degLat=1/111320, m2degLon=1/(111320*Math.cos(lat*Math.PI/180));
    function quad(a,b){ const dx=(b.lng-a.lng), dy=(b.lat-a.lat), len=Math.hypot(dx,dy)||1e-9; const ux=-dy/len, uy=dx/len; const offLon=ux*width*m2degLon, offLat=uy*width*m2degLat; return [[a.lat-offLat,a.lng-offLon],[a.lat+offLat,a.lng+offLon],[b.lat+offLat,b.lng+offLon],[b.lat-offLat,b.lng-offLon]]; }
    [[a0,a1],[a1,a2],[a2,a3]].forEach((seg,i)=> L.polygon(quad(seg[0],seg[1]), { className:'runway-rect '+classForThird(i) }).addTo(runwayLayer));
  }
}
map.on('zoomend', ()=>{ if(state.selectedICAO) drawRunwaysFor(state.selectedICAO); });

/* popup */
function buildPopupHTML(icao){
  const a=state.airportsByIcao.get(icao)||{};
  const metar=state.metarByIcao.get(icao)||'Loading…'; const taf=state.tafByIcao.get(icao)||'Loading…';
  const snow=state.snowtamByIcao.get(icao);
  const cat = snow?.category ? (snow.category==='RED'?'RED':snow.category==='ORANGE'?'ORANGE':'YELLOW') : '';
  return `<div class="popup">
    <h3>${icao} — ${a.name||''} ${cat?`<span style="padding:2px 6px;border-radius:999px;background:${cat==='RED'?'#ffe5e5':cat==='ORANGE'?'#fff0e0':'#fff7dd'};border:1px solid #ccc;">SNOWTAM: ${cat}</span>`:''}</h3>
    <div><strong>METAR</strong></div><pre id="m_${icao}">${metar}</pre>
    <div><strong>TAF</strong></div><pre id="t_${icao}">${taf}</pre>
    <div style="display:flex;gap:6px;margin:6px 0;">
      <button class="btn" onclick="window.__refetch('${icao}','metar',this)">Re-fetch METAR</button>
      <button class="btn" onclick="window.__refetch('${icao}','taf',this)">Re-fetch TAF</button>
      <button class="btn" onclick="window.__refetch('${icao}','snow',this)">Re-fetch SNOWTAM</button>
      <span style="opacity:.7;font-size:12px;align-self:center;">Zoom ≥ 10 for runway thirds.</span>
    </div>
    <div><strong>SNOWTAM (raw)</strong></div><pre>${snow?.raw||'—'}</pre>
    <div><strong>SNOWTAM (decoded)</strong></div><pre>${snow?.decoded||'—'}</pre>
  </div>`;
}
function rebuildPopup(icao){ const a=state.airportsByIcao.get(icao); if(!a) return; L.popup({maxWidth:720,autoPan:true}).setLatLng([a.lat,a.lon]).setContent(buildPopupHTML(icao)).openOn(map); }
async function onAirportClick(icao){
  state.selectedICAO=icao; const a=state.airportsByIcao.get(icao); if(!a) return;
  if(map.getZoom()<11) map.setView([a.lat,a.lon],11); else map.panTo([a.lat,a.lon]);
  rebuildPopup(icao); drawRunwaysFor(icao);
  fetchMetarOne(icao); fetchTafOne(icao);
  const snow=await fetchSnowtamFAA(icao); if(snow){ state.snowtamByIcao.set(icao,snow); styleMarker(icao,snow.category); drawRunwaysFor(icao); rebuildPopup(icao); }
}
window.__refetch = async (icao,what,btn)=>{
  if(btn){ btn.disabled=true; btn.dataset.prev=btn.textContent; btn.textContent='Fetching…'; }
  if(what==='metar') await fetchMetarOne(icao); else if(what==='taf') await fetchTafOne(icao); else { const a=state.airportsByIcao.get(icao); const s=await fetchSnowtamFAA(icao); if(s){ state.snowtamByIcao.set(icao,s); styleMarker(icao,s.category); drawRunwaysFor(icao); rebuildPopup(icao);} }
  if(btn){ btn.textContent=btn.dataset.prev; btn.disabled=false; }
};

/* refresh buttons */
async function refreshAll(btn){
  try{ if(btn){btn.disabled=true;btn.dataset.prev=btn.textContent;btn.textContent='Refreshing…';}
    const icaos=Array.from(state.airportsByIcao.keys()); const chunk=120;
    for(let i=0;i<icaos.length;i+=chunk){
      const part=icaos.slice(i,i+chunk);
      try{ const t=await fetchViaAll(SRC.metar(part.join(','))); t.split('\n').forEach(s=>{s=s.trim(); if(s){ state.metarByIcao.set(s.slice(0,4).toUpperCase(), s);} }); }catch(e){}
      try{ const t=await fetchViaAll(SRC.taf(part.join(','))); t.split('\n').forEach(s=>{s=s.trim(); if(s){ state.tafByIcao.set(s.slice(0,4).toUpperCase(), s);} }); }catch(e){}
    }
    toast('METAR/TAF refresh completed.');
  } finally { if(btn){btn.textContent=btn.dataset.prev;btn.disabled=false;} if(state.selectedICAO) rebuildPopup(state.selectedICAO); }
}
document.getElementById('btn-refresh').addEventListener('click', (e)=> refreshAll(e.currentTarget));
document.getElementById('btn-auto').addEventListener('click', (e)=>{
  const on=e.currentTarget.dataset.on==='1';
  if(on){ clearInterval(state.autoTimer); state.autoTimer=null; e.currentTarget.dataset.on='0'; e.currentTarget.textContent='Auto 15m: OFF'; }
  else { state.autoTimer=setInterval(()=>refreshAll(), 15*60*1000); e.currentTarget.dataset.on='1'; e.currentTarget.textContent='Auto 15m: ON'; }
});
document.getElementById('btn-reload').addEventListener('click', ()=> loadAirports());

/* boot */
(async function boot(){
  await loadAirports();
  await loadRunways();
  await refreshAll();
  state.autoTimer=setInterval(()=>refreshAll(), 15*60*1000);
  say('Ready. If you only see the fallback set, your network blocks the OurAirports CSV — try another network or keep using fallback.');
})();
</script>
</body>
</html>
